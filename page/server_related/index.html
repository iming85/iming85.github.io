<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Ming Yi, Personal Website, Huazhong University of Science and Technology, 易鸣, 华中科技大学, 个人主页" />








  <link rel="shortcut icon" type="image/x-icon" href="/uploads/logo.png?v=5.1.1" />






<meta name="description" content="1. 机器配置 2. 安装操作系统 3. Ubuntu系统设置  3.1 给root用户添加密码 3.2 更换ubuntu下载源 3.3 安装Nvidia显卡驱动  3.3.1 安装Nvidia驱动 3.3.2 禁用nouveau驱动   3.4 开启网络服务  3.4.1 开启ssh服务 3.4.2 给root账户ssh登陆权限 3.4.3 关于远程桌面（安装xrdp）   3.5 公网">
<meta property="og:type" content="website">
<meta property="og:title" content="服务器相关信息">
<meta property="og:url" content="https://iming85.github.io/page/server_related/index.html">
<meta property="og:site_name" content="Ming Yi&#39;s Personal Website">
<meta property="og:description" content="1. 机器配置 2. 安装操作系统 3. Ubuntu系统设置  3.1 给root用户添加密码 3.2 更换ubuntu下载源 3.3 安装Nvidia显卡驱动  3.3.1 安装Nvidia驱动 3.3.2 禁用nouveau驱动   3.4 开启网络服务  3.4.1 开启ssh服务 3.4.2 给root账户ssh登陆权限 3.4.3 关于远程桌面（安装xrdp）   3.5 公网">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://iming85.github.io/page/server_related/files/machine_specs.png">
<meta property="og:image" content="https://iming85.github.io/page/server_related/files/gpu_info.png">
<meta property="og:image" content="https://iming85.github.io/page/server_related/files/sshd_check.png">
<meta property="og:image" content="https://iming85.github.io/page/server_related/files/xrdp_instance.png">
<meta property="og:image" content="https://iming85.github.io/page/server_related/files/aliyun_server.png">
<meta property="og:image" content="https://iming85.github.io/page/server_related/files/frps_success.png">
<meta property="og:image" content="https://iming85.github.io/page/server_related/files/ali_banned.png">
<meta property="og:image" content="https://iming85.github.io/page/server_related/files/frps_web.png">
<meta property="og:image" content="https://iming85.github.io/page/server_related/files/explain_xtcp.png">
<meta property="og:image" content="https://iming85.github.io/page/server_related/files/speed_compare.PNG">
<meta property="og:image" content="https://iming85.github.io/page/server_related/files/speed_compare1.png">
<meta property="og:image" content="https://iming85.github.io/page/server_related/files/ssh_welcome.png">
<meta property="og:image" content="https://iming85.github.io/page/server_related/files/mounted_disk.png">
<meta property="og:image" content="https://iming85.github.io/page/server_related/files/permission_status1.png">
<meta property="og:image" content="https://iming85.github.io/page/server_related/files/permission_status2.png">
<meta property="og:image" content="https://iming85.github.io/page/server_related/files/permission_check.png">
<meta property="og:updated_time" content="2024-07-20T09:38:56.227Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="服务器相关信息">
<meta name="twitter:description" content="1. 机器配置 2. 安装操作系统 3. Ubuntu系统设置  3.1 给root用户添加密码 3.2 更换ubuntu下载源 3.3 安装Nvidia显卡驱动  3.3.1 安装Nvidia驱动 3.3.2 禁用nouveau驱动   3.4 开启网络服务  3.4.1 开启ssh服务 3.4.2 给root账户ssh登陆权限 3.4.3 关于远程桌面（安装xrdp）   3.5 公网">
<meta name="twitter:image" content="https://iming85.github.io/page/server_related/files/machine_specs.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"hide","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false,"onmobile":true},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: "",
      labels: ""
    }
  };
</script>



  <link rel="canonical" href="https://iming85.github.io/page/server_related/"/>





  <title>服务器相关信息 | Ming Yi's Personal Website</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-99364178-1', 'auto');
  ga('send', 'pageview');
</script>











</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Ming Yi's Personal Website</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-about me">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About Me
          </a>
        </li>
      
        
        <li class="menu-item menu-item-teaching">
          <a href="/categories/Course/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />
            
            Teaching
          </a>
        </li>
      
        
        <li class="menu-item menu-item-workshop">
          <a href="/categories/Workshop-Seminar/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-university"></i> <br />
            
            Workshop
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
  <header class="post-header">

	<h1 class="post-title" itemprop="name headline">服务器相关信息</h1>



</header>

    
    
      <br>
<br>
<!-- toc -->
<ul>
<li><a href="#1-ji-qi-pei-zhi">1. 机器配置</a></li>
<li><a href="#2-an-zhuang-cao-zuo-xi-tong">2. 安装操作系统</a></li>
<li><a href="#3-ubuntu-xi-tong-she-zhi">3. Ubuntu系统设置</a>
<ul>
<li><a href="#3-1-gei-root-yong-hu-tian-jia-mi-ma">3.1 给root用户添加密码</a></li>
<li><a href="#3-2-geng-huan-ubuntu-xia-zai-yuan">3.2 更换ubuntu下载源</a></li>
<li><a href="#3-3-an-zhuang-nvidia-xian-qia-qu-dong">3.3 安装Nvidia显卡驱动</a>
<ul>
<li><a href="#3-3-1-an-zhuang-nvidia-qu-dong">3.3.1 安装Nvidia驱动</a></li>
<li><a href="#3-3-2-jin-yong-nouveau-qu-dong">3.3.2 禁用nouveau驱动</a></li>
</ul>
</li>
<li><a href="#3-4-kai-qi-wang-luo-fu-wu">3.4 开启网络服务</a>
<ul>
<li><a href="#3-4-1-kai-qi-ssh-fu-wu">3.4.1 开启ssh服务</a></li>
<li><a href="#3-4-2-gei-root-zhang-hu-ssh-deng-lu-quan-xian">3.4.2 给root账户ssh登陆权限</a></li>
<li><a href="#3-4-3-guan-yu-yuan-cheng-zhuo-mian-an-zhuang-xrdp">3.4.3 关于远程桌面（安装xrdp）</a></li>
</ul>
</li>
<li><a href="#3-5-gong-wang-ip-yu-nei-wang-chuan-tou">3.5 公网ip与内网穿透</a>
<ul>
<li><a href="#3-5-1-zai-yun-fu-wu-qi-shang-an-zhuang-frps-server">3.5.1 在云服务器上安装frps (server)</a></li>
<li><a href="#3-5-2-zai-ben-ji-qi-shang-an-zhuang-frpc-client">3.5.2 在本机器上安装frpc (client)</a></li>
<li><a href="#3-5-3-ke-xuan-kai-qi-frp-de-xtcp-fu-wu-shi-xian-duan-dui-duan-gao-su-nei-wang-chuan-tou">3.5.3 （可选）开启frp的xtcp服务，实现端对端高速内网穿透</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#4-chang-yong-ji-suan-ruan-jian-an-zhuang">4. 常用计算软件安装</a></li>
<li><a href="#5-fu-wu-qi-wei-hu-za-xiang">5. 服务器维护杂项</a>
<ul>
<li><a href="#5-1-xiu-gai-ssh-deng-lu-huan-ying-jie-mian">5.1 修改ssh登陆欢迎界面</a></li>
<li><a href="#5-2-guan-li-user-he-group">5.2 管理user和group</a></li>
<li><a href="#5-3-xiu-gai-yong-hu-mi-ma-ce-lue">5.3 修改用户密码策略</a></li>
<li><a href="#5-4-gua-zai-ci-pan-ji-she-zhi-yong-hu-qun-zu-quan-xian">5.4 挂载磁盘及设置用户群组权限</a>
<ul>
<li><a href="#5-4-1-ge-shi-hua-yu-gua-zai-ci-pan">5.4.1 格式化与挂载磁盘</a></li>
<li><a href="#5-4-2-she-zhi-yong-hu-qun-zu-quan-xian">5.4.2 设置用户群组权限</a></li>
</ul>
</li>
<li><a href="#5-5-xiu-gai-ji-qi-ming-cheng">5.5 修改机器名称</a></li>
<li><a href="#5-6">5.6</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->
<br>
<h1><span id="1-ji-qi-pei-zhi">1. 机器配置</span></h1>
<p>2024年7月收到的机器，配置信息概要如下：</p>
<ul>
<li><strong>CPU</strong>：两块Xeon Gold 6266C 3.00GHZ芯片。22核、44线程、Max 3.4GHz。型号中的“C”代表定制版。</li>
<li><strong>内存</strong>: 4根Samsung 32G DDR4服务器内存，共128G。</li>
<li><strong>GPU</strong>: 两张 NVIDIA GeForce RTX4090D显卡。</li>
<li><strong>存储</strong>：系统盘为2T的Samsung SSD，存储盘是由两块4T机械硬盘组成的4T容量的RAID1阵列（重要数据可备份于此，一般资料存放于系统盘<code>\home</code>分区下即可）。</li>
<li><strong>其他</strong>：ASUS WS-C621E-SAGE双路主板、1600W白金电源、Enthoo Pro Panteks追风者机箱。<br>
<img src="/page/server_related/files/machine_specs.png" alt="image"></li>
</ul>
<br>
<h1><span id="2-an-zhuang-cao-zuo-xi-tong">2. 安装操作系统</span></h1>
<ul>
<li><strong>centos还是ubuntu？</strong> 供货商提前装好了<em>centos7</em>后交货的。考虑到<em>centos7</em>已于2024年7月停止更新、<em>centos stream</em>是RHEL的上游测试版，以及本机器主要用作机器学习工作站（提供ssh服务）、而非用于网站服务器运营。我决定将操作系统更换为<em>ubuntu</em>。这样做可能牺牲了一点可靠性（<em>centos</em>较<em>ubuntu</em>更为稳定），但在日后维护、系统安全升级、驱动与软件安装方面的收益是压倒性的（<em>ubuntu</em>是众多机器学习工具包默认操作系统，且拥有更大的社群支持、更新更全面的linux体验）。</li>
<li><strong>ubuntu desktop还是server?</strong> 目前最新的稳定版本为ubuntu 24.04LTS，默认提供5年的支持，但加入<em>ubuntu pro</em>（免费）后，课提供长达10年的支持。对于24.04LTS，桌面版与服务器版拥有同样的内核与仓库，日后可以通过简单的命令相互转换。两者的区别主要在于：桌面版的安装程序更大，因为默认带有GUI界面，而服务器版本默认是没有GUI的（后期可以通过简单命令行安装与卸载GUI）；服务器版默认带有更多网络协议。<br>
我最终的选择是：安装ubuntu desktop版，再手动安装ssh、ftp等网络协议，将机器变为服务器。使用半年后，视情况考虑卸载GUI，将机器变成headless server。</li>
<li><strong>安装ubuntu desktop。</strong> 去ubuntu官网下载24.04LTS desktop版的安装程序（约6G大小，使用迅雷下载速度更快），在windows电脑上用Ultraiso打开下载的.iso文件，并使用“启动“下的“写入硬盘映像”功能，将插入的U盘制作为启动盘。接着将U盘插入机箱，开机后按住<strong>Del</strong>键进入BIOS设定，修改BOOT顺序后重启，进入ubuntu安装流程。</li>
<li><strong>ubuntu desktop自带驱动与Nvidia显卡的不兼容问题。</strong> ubuntu自带的显卡驱动nouveau与NVIDIA独立显卡之间可能不兼容。在安装ubuntu desktop过程中，需要图形界面做引导，如果显示器连接的是集成显（往往是VGA接口），一般不会有问题。但如果显示器连接的是Nvidia显卡（往往是Hdmi、DisplayPort等接口）， 会导致安装画面静止不动（如果安装ubuntu server，通过命令行做引导，则无此问题），看起来像死机的状态。
<ul>
<li>如果安装系统时不得不用Nvidia显卡连接显示器，上述问题的解决办法，是在保存BOOT更改顺序后重启时，进入<strong>GRUB</strong>界面选择启动项时（如果没有进入GRUB界面，则在开机后长按住<code>Shift</code>键），将光标移动至Install Ubuntu选项后，不要直接按Enter键，而是按下<code>e</code>键进行启动选项编辑，并在开头为linux的那一行（一般来说是倒数第二行），在<code>quiet splash</code>后面空一格再加上<code>acpi_osi=linux nomodeset</code>（有时<code>quiet splash</code>后面本就有别的字符，不用管它，确保我们要加的字符插入<code>splash</code>后面即可），修改完成后<code>Ctrl+X</code>或者<code>F10</code>推出就能进入正常安装流程。</li>
<li>注意：上面的问题，在成功安装ubuntu、拔出安装u盘后，机器重启第一次进入系统时，还会存在（一直黑屏）。而且如果安装过程中选择了格式化整个系统盘、抹掉原有系统，那么机器开机时只会找到一个BOOT源，继而自动跳过GRUB界面。解决的办法，仍然是在开机的时候就长按<code>Shift</code>键，出现GRUB界面后，再在进入ubuntu系统的选项上按<code>e</code>键，重复上述操作，加入相应字符，即可首次进入系统。</li>
<li><strong>在GUI与命令行界面中切换。</strong> ubuntu系统运行时，<code>Ctrl+Alt+F3</code>默认切换到命令行界面，<code>Ctrl+Alt+F2</code>切换到图形界面（从<code>F1</code>到<code>F6</code>都有类似的<strong>tty</strong>功能)。如果后续运行中独立显卡驱动除了问题，可使用这个办法进入图形界面进行操作（例如将nouveau从禁止列表中暂时删除）。</li>
</ul>
</li>
<li><strong>磁盘分区选择。</strong> ubuntu安装过程中，最好不要选择默认安装模式，而是选择手动分区，因为前者只会设置一个根目录分区。一般来说，我们需要至少将<code>/home</code>独立分区，这样如果将来需要重装系统，我们只需要覆盖根目录后，再将原有的<code>/home</code>分区挂载在系统上即可，这样不用折腾用户资料。<br>
目前操作系统占用了整个系统盘2T空间，除了安装引导程序自动选择的<code>/boot/efi</code>分区（大概1.3G）以外，其他分区选择如下：
<ul>
<li>根目录<code>/</code>，分给370G，用于存放系统文件和大部分计算相关软件。</li>
<li>目录 <code>/home</code>，分给了1.48T。</li>
<li>交换分区<code>SWAP</code>，机器内存有128G，从运行的角度来看，其实可以不设置交换分区。但考虑到未来可能有休眠的需求，交换分区最好为内存容量的1.1倍（以便将内存中所有数据写入硬盘了再关机），分给了144G（后续使用中，如果确无需要，还可以再修改<code>SWAP</code>分区大小，释放更多空间给前面两个分区）。</li>
</ul>
</li>
</ul>
<br>
<h1><span id="3-ubuntu-xi-tong-she-zhi">3. Ubuntu系统设置</span></h1>
<h2><span id="3-1-gei-root-yong-hu-tian-jia-mi-ma">3.1 给root用户添加密码</span></h2>
<ul>
<li>首次进入系统后，给root添加密码：<code>sudo passwd root</code>。</li>
<li>同时，也可考虑给当前用户（一般为服务器管理员）sudo权限：<code>sudo visudo</code>后，在末尾加上<code>xxxyyyzzz ALL=(ALL) NOPASSWD: ALL</code>  后保存退出，其中<code>xxxyyyzzz</code> 为当前用户。</li>
</ul>
<h2><span id="3-2-geng-huan-ubuntu-xia-zai-yuan">3.2 更换ubuntu下载源</span></h2>
<p>可将ubuntu的仓库下载源更换为国内服务器（有多个大学以及阿里、华为等源可选择），这样以后从仓库下载、更新软件速度会快一些。下述<strong>两种办法都可以</strong>：</p>
<ul>
<li><strong>图形界面方式</strong>：在桌面点击<code>Show Apps</code>后，选择<code>Software Updater</code>，再进入<code>Settings</code>后，于选项卡<code>Ubuntu Software</code>中弹开<code>Download from</code> 并选择<code>Other</code>，然后选择国内的ali源。或者使用Select Best Server功能选择下载测试速度最快的节点，最后根据系统提示点击<code>reload</code>即可启用新源。</li>
<li><strong>命令行方式</strong>：命令行中打开文件<code>sudo nano /etc/apt/sources.list.d/ubuntu.sources</code>，将内容替换为：</li>
</ul>
<pre><code>Types: deb deb-src
URIs: https://mirrors.aliyun.com/ubuntu/
Suites: noble noble-updates noble-backports noble-security noble-proposed
Components: main restricted universe multiverse
Signed-By: /usr/share/keyrings/ubuntu-archive-keyring.gpg

Types: deb deb-src
URIs: https://mirrors.tuna.tsinghua.edu.cn/ubuntu/
Suites: noble noble-updates noble-backports noble-security noble-proposed
Components: main restricted universe multiverse
Signed-By: /usr/share/keyrings/ubuntu-archive-keyring.gpg

Types: deb deb-src
URIs: http://mirrors.163.com/ubuntu/
Suites: noble noble-updates noble-backports noble-security noble-proposed
Components: main restricted universe multiverse
Signed-By: /usr/share/keyrings/ubuntu-archive-keyring.gpg

Types: deb deb-src
URIs: https://mirrors.ustc.edu.cn/ubuntu/
Suites: noble noble-updates noble-backports noble-security noble-proposed
Components: main restricted universe multiverse
Signed-By: /usr/share/keyrings/ubuntu-archive-keyring.gpg

Types: deb
URIs: http://cn.archive.ubuntu.com/ubuntu/
Suites: noble noble-updates noble-backports
Components: main restricted universe multiverse
Signed-By: /usr/share/keyrings/ubuntu-archive-keyring.gpg

Types: deb
URIs: http://security.ubuntu.com/ubuntu/
Suites: noble-security
Components: main restricted universe multiverse
Signed-By: /usr/share/keyrings/ubuntu-archive-keyring.gpg
</code></pre>
<p>最后，无论使用哪种方法，都需要更新下载设置以及系统软件：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo apt-get update</div><div class="line">sudo apt-get update</div><div class="line">sudo apt-get install g++ gcc make</div></pre></td></tr></table></figure>
<h2><span id="3-3-an-zhuang-nvidia-xian-qia-qu-dong">3.3 安装Nvidia显卡驱动</span></h2>
<p>此部分共分为两个步骤：安装Nvidia显卡驱动，禁用系统自带的nouveau驱动。</p>
<h3><span id="3-3-1-an-zhuang-nvidia-qu-dong">3.3.1 安装Nvidia驱动</span></h3>
<p>网上能搜到很多命令行方式，但最简单的方法，其实就是直接使用ubuntu的图形界面引导：在<code>Software Updater</code>里面选择<code>Settings</code>，然后进入<code>Additional Drivers</code>选项卡。在连接上互联网的情况下，系统会自动发现Nvidia显卡驱动，选择最前面一个安装即可。以RTX4090D显卡为例，这里推荐的Nvidia驱动版本与官网上查到的一样（都为550）。</p>
<p>在终端输入：<code>nvidia-smi</code>，如能显示显卡信息，就说明Nvidia显卡驱动安装成功。<br>
<img src="/page/server_related/files/gpu_info.png" alt="image"></p>
<h3><span id="3-3-2-jin-yong-nouveau-qu-dong">3.3.2 禁用nouveau驱动</span></h3>
<p>系统自带驱动nouveau的存在，会阻止系统自动使用Nvidia显卡驱动。解决办法是将前者禁用。<br>
打开文件<code>sudo nano /etc/modprobe.d/blacklist.conf</code>，并在文件末尾添加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">blacklist nouveau</div><div class="line">options nouveau modeset=0</div></pre></td></tr></table></figure>
<p>改完要更新系统镜像文件，在终端中输入：<code>sudo update-initramfs -u</code><br>
完成后重启Ubuntu，开机后在终端中输入：<code>lsmod | grep nouveau</code><br>
如果没有输出就说明禁用了nouveau</p>
<h2><span id="3-4-kai-qi-wang-luo-fu-wu">3.4 开启网络服务</span></h2>
<p>当安装的desktop版、且选择的最小安装模式时，系统里面没有自带ssh、ftp等网络服务。需要手动开启。</p>
<h3><span id="3-4-1-kai-qi-ssh-fu-wu">3.4.1 开启ssh服务</span></h3>
<p>在终端中输入：<code>sudo apt install ssh</code>，即可安装并自动开启ssh服务和sftp服务。<br>
注意使用ftp代理软件连接服务器时，记得选择<strong>SFTP</strong>连接，因为服务器使用的是<strong>SSH File Transfer Protocol</strong>。</p>
<p>可在终端输入命令查看ssh是否运行了：<code>ps -e | grep ssh</code>。<br>
<img src="/page/server_related/files/sshd_check.png" width="500px"></p>
<p>ssh和sftp代理软件，市面上有挺多。windows下，可分别使用Xshell和Xftp（去<a href="https://www.xshell.com/zh/free-for-home-school/" target="_blank" rel="external">NetSarang官网</a>下载正版，个人用户免费）。<br>
mac下，可分别使用系统自带的terminal和FileZilla。</p>
<p>也可以所有设备（包括macos, windows, linux, ios, anroid）均使用或使用个人免费版的<a href="https://termius.com/download" target="_blank" rel="external">Termius</a>，界面简洁漂亮、集合了ssh和sftp功能，每台设备都注册一个单独的账号即可。</p>
<h3><span id="3-4-2-gei-root-zhang-hu-ssh-deng-lu-quan-xian">3.4.2 给root账户ssh登陆权限</span></h3>
<p>root账户的级别太高，为了安全起见，系统默认是禁止root账户通过ssh登陆的。如果一般的用户已经拥有了sudo权限，那么可以使用该用户登陆后再通过<code>su root</code>命令切换到root用户，这是更为稳妥的办法。</p>
<p>但是如果需要开通root的ssh登陆权限的话，可以这么做：<br>
首先，编辑文件：<code>sudo nano /etc/ssh/sshd_config</code><br>
在文件中找到这么一行：<br>
<code>PermitRootLogin prohibit-password</code><br>
将文中的<strong>prohibit-password</strong>替换成<strong>yes</strong>，保存后退出，<br>
再重启ssd服务即可：<br>
<code>sudo systemctl restart ssh</code></p>
<h3><span id="3-4-3-guan-yu-yuan-cheng-zhuo-mian-an-zhuang-xrdp">3.4.3 关于远程桌面（安装xrdp）</span></h3>
<p>尽管一般的数据传输、计算运行通过ssh均可高效达成，偶尔也会碰到需要连接远程桌面的场景。</p>
<p>当无法解决公网ip问题时，可使用<strong>向日葵(sunlogin)<strong>等常见的远程控制软件。当拥有公网ip时，则可使用</strong>rdp</strong>和<strong>vnc</strong>等连接方式。</p>
<p><strong>向日葵</strong>的安装、注册、使用方式，是平凡的，下面记录一下<code>xrdp</code>搭建过程：<br>
首先是安装：<code>sudo apt install xrdp</code><br>
安装完成后，xrdp服务将会自动启动，可以输入这个命令验证：<code>sudo systemctl status xrdp</code></p>
<p>默认情况下，xrdp 使用/etc/ssl/private/ssl-cert-snakeoil.key，它仅仅对ssl-cert用户组成员可读，所以需要运行下面的命令，将<code>xrdp</code>（安装服务过程中生成的虚拟用户）添加到这个用户组，且让xrdp于启动时（而非登陆时）运行，并允许访问xrdp的默认端口号3389，并查看3389端口是否已经放行 ：<br>
<code>sudo adduser xrdp ssl-cert</code><br>
<code>sudo systemctl enable xrdp</code><br>
<code>sudo systemctl restart xrdp</code><br>
<code>sudo ufw allow 3389</code><br>
<code>sudo lsof -i:3389</code></p>
<p>最后使用Windows自带的远程桌面软件（或者mac在app store里面下载的Microsoft Remote Desktop）连接服务器IP地址即可。xrdp环境下，可实现桌面同步、文件复制粘贴、甚至声音同步。</p>
<p><strong>注意</strong>：在ubuntu中，每个用户只可以登陆一次桌面（不像ssh，可以有多个instances），所以如果一个账号在本地已经登陆了桌面，是无法通过xrdp建立远程桌面连接的。测试的时候要注意这点，不要误以为没有设置好。<br>
<img src="/page/server_related/files/xrdp_instance.png" alt="image"></p>
<h2><span id="3-5-gong-wang-ip-yu-nei-wang-chuan-tou">3.5 公网ip与内网穿透</span></h2>
<p>目前为止，机器的远程连接只能在局域网下进行。这是因为无论是将服务器放置于家里还是放置于办公室，机器的ip地址，都只是经过多层NAT转换后的内网地址（尽管可以设置为静态ip以方便在内网使用）。而内网ip地址是无法在公网通过ssh或者sftp连接的。</p>
<p>为了能随时随地连接服务器，我们需要实现内网穿透。方式有两种：1. 通过花生壳之类的DDNS服务器平台做转发（简单稳定，持续付费，每个端口都要额外付费）。2. 自己搭建具备公网ip的云服务器，通过frp之类的软件做反响代理来实现内网穿透（便宜，端口数量可以任意设定）。</p>
<p>这几年国内云服务器行业产能过剩，一直在降价。截至2024年7月，最大的两家阿里云和腾讯云都有99元/年的云服务器产品出售。机器配置一样，均为2核2G，约40G的ssd。不同之处在于腾讯云提供<strong>4M固定带宽和300G每月流量限制</strong>，而阿里云提供<strong>3M固定带宽和无限流量</strong>。综合比较后，我决定选用阿里云的ecs弹性服务器经济型。购买订单见下图，官方宣称的折扣信息很搞笑。</p>
<img src="/page/server_related/files/aliyun_server.png" width="500px">     
<p>下面介绍如何安装配置frp：<br>
frp分为frps（server）和frpc（client）两个包 ，前者安装在阿里云服务器上，后者安装在本机器上。</p>
<h3><span id="3-5-1-zai-yun-fu-wu-qi-shang-an-zhuang-frps-server">3.5.1 在云服务器上安装frps (server)</span></h3>
<p>先去<a href="https://github.com/fatedier/frp/releases" target="_blank" rel="external">frp主页</a>下载适合的版本。本机器操作系统是ubuntu24，阿里云服务器为ubuntu22，因此下版本为**frp_0.59.0_linux_amd64.tar.gz<br>
**的安装文件，可供两台机器使用。</p>
<p>将安装文件上传至阿里云服务器的某新建路径下。既可以通过sftp传输，也可以在阿里云中输入下面命令完成：<br>
<code>wget https://github.com/fatedier/frp/releases/download/v0.59.0/frp_0.59.0_linux_amd64.tar.gz</code></p>
<p>在阿里云中解压缩：<br>
<code>tar -zxvf frp_0.59.0_linux_amd64.tar.gz</code></p>
<p>进入解压缩后得到的路径，看到两个二进制文件，将他们移动到/usr/local/bin目录中以方便运行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo mv frps /usr/local/bin  </div><div class="line">sudo mv frpc /usr/local/bin</div></pre></td></tr></table></figure>
<p>接下来，我们为frp server创建一个配置文件：<br>
<code>sudo mkdir /etc/frp</code><br>
<code>sudo mv frps.toml /etc/frp/</code><br>
<code>sudo mv frpc.toml /etc/frp/</code><br>
<code>sudo nano /etc/frp/frps.toml</code></p>
<p>往frps.toml中写入下列内容并保存：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[common]</div><div class="line"># frp服务的端口号，可以自己定</div><div class="line">bind_port = 5000 </div><div class="line"></div><div class="line"># frp的web界面的端口号，可以自己定</div><div class="line">dashboard_port = 5500</div><div class="line"></div><div class="line"># web界面的登陆账户，自己修改</div><div class="line">dashboard_user = user </div><div class="line"></div><div class="line"># web界面的登陆密码，自己修改</div><div class="line">dashboard_pwd = pass </div><div class="line"></div><div class="line">authentication_method = token</div><div class="line"># frp客户端连接时的密码，自己修改</div><div class="line">token = xxxxx</div></pre></td></tr></table></figure>
<p>保存配置后，使用下面命令启动frp server：<br>
<code>frps -c /etc/frp/frps.toml</code></p>
<p>看起来阿里云服务器成功运行frps了：<br>
<img src="/page/server_related/files/frps_success.png" alt="image"></p>
<p>接下来，为frps添加服务，并设置开机运行。<br>
首先，在/etc/systemd/system/路径下新建服务文件：<br>
<code>sudo nano /etc/systemd/system/frps.service</code></p>
<p>在文件中写入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[Unit]</div><div class="line">Description=Frp Server Service</div><div class="line">After=network.target</div><div class="line"></div><div class="line">[Service]</div><div class="line">Type=simple</div><div class="line">User=nobody</div><div class="line">Restart=on-failure</div><div class="line">RestartSec=5s</div><div class="line">ExecStart=/usr/local/bin/frps -c /etc/frp/frps.toml</div><div class="line">ExecReload=/usr/local/bin/frps reload -c /etc/frp/frps.toml</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div></pre></td></tr></table></figure>
<p>最后，刷新服务列表，设置开机自启、启动frps.service：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo systemctl daemon-reload</div><div class="line">sudo systemctl enable frps.service</div><div class="line">sudo systemctl start frps.service</div></pre></td></tr></table></figure>
<p>阿里云重启后，在终端确认frps.service的状态是成功启动：<br>
<code>sudo systemctl status frps.service</code></p>
<p>在浏览器输入 [云服务器的公网ip]:5500 即可访问到frp的web管理界面。</p>
<p>如果无法访问该页面，要么是因为云服务器开启了防火墙，需要去开启特定端口；要么是因为云服务器商关闭了端口。<br>
经过排查，阿里云服务器中甚至都没有开启防火墙（ufw状态是inactive)。<br>
问题发生在阿里云的“安全组”功能，阿里云默认关闭了服务器出了必要端口外的所有端口访问。解决办法，是登陆阿里云，找到云服务器的实例后，在“安全组”下，选择“管理规则”，再手动添加放行端口即可，如下图：<br>
<img src="/page/server_related/files/ali_banned.png" alt="image"></p>
<p>虽然启动frps服务我们其实只需要放行5000和5500这两个端口。但frp可以反向代理任意数量的设备和任意数量的服务，每个设备的每个服务都对应一个特定的端口。因此我们开放了1001个端口为未来需求作准备。</p>
<p>现在去浏览器输入 [云服务器的公网ip]:5500，能看到frp的web管理界面了：<br>
<img src="/page/server_related/files/frps_web.png" alt="image"></p>
<h3><span id="3-5-2-zai-ben-ji-qi-shang-an-zhuang-frpc-client">3.5.2 在本机器上安装frpc (client)</span></h3>
<p>有了前面的铺垫，在本服务器上安装frpc，就特别简单了。除了配置文件有所不同，整个步骤几乎一样（只是将命令中的frps换成了frpc）。</p>
<p><strong>第一步</strong>，在本服务器上安装frp软件，放置和创建好各个文件。frp软件，既可以像前文中阿里云服务器那样使用<code>wget</code>命令从官网下载，也可以使用<code>scp</code>命令从阿里云服务器直接下载（假设阿里云的ip为101.102.103.104。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">mkdir frp   </div><div class="line">scp  root@101.102.103.104:/root/frp/frp_0.59.0_linux_amd64.tar.gz frp/         </div><div class="line">cd frp    </div><div class="line">tar -zxvf frp_0.59.0_linux_amd64.tar.gz    </div><div class="line">cd frp*64     </div><div class="line">sudo mv frps /usr/local/bin   </div><div class="line">sudo mv frpc /usr/local/bin     </div><div class="line">sudo mkdir /etc/frp     </div><div class="line">sudo mv frps.toml /etc/frp/      </div><div class="line">sudo mv frpc.toml /etc/frp/</div></pre></td></tr></table></figure>
<p><strong>第二步</strong>，完成frpc配置。<br>
打开配置文件<code>sudo nano /etc/frp/frpc.toml</code>  并写入下列内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"># 客户端配置</div><div class="line">[common]</div><div class="line">#阿里云服务器的ip地址</div><div class="line">server_addr = xxxx</div><div class="line"># 与frps.ini的bind_port一致</div><div class="line">server_port = 5000 </div><div class="line"># 与frps.toml的token一致</div><div class="line">token = xxxxx  </div><div class="line"></div><div class="line"></div><div class="line">### frps是通过下面设定中的[服务名称]和remote_port来区分不同frpc上的代理需求的。</div><div class="line">### 因此服务名称不要简单使用诸如ssh、web等，可附带上设备信息。</div><div class="line"></div><div class="line"># 配置ssh服务，自定义名称，可区分设备。</div><div class="line">[melonlon-ssh]   </div><div class="line">type = tcp</div><div class="line">local_ip = 127.0.0.1</div><div class="line">local_port = 22</div><div class="line"># 这个自定义，之后再ssh连接的时候要用</div><div class="line">remote_port = 5022  </div><div class="line"></div><div class="line"># 配置xrdp服务</div><div class="line">[melonlon-rdp]  </div><div class="line">type = tcp     </div><div class="line">local_ip = 127.0.0.1      </div><div class="line">## 前文中xrdp远程桌面的本地机器端口</div><div class="line">local_port = 3389        </div><div class="line"> remote_port = 5389</div></pre></td></tr></table></figure>
<p>测试确认frpc可以正常开启：<br>
<code>frpc -c /etc/frp/frpc.toml</code></p>
<p><strong>第三步</strong>，在本服务器上创建frpc.service，并设置开机自动启动。<br>
在/etc/systemd/system/路径下新建服务文件：<br>
<code>sudo nano /etc/systemd/system/frpc.service</code></p>
<p>在文件中写入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[Unit]</div><div class="line">Description=Frp Client Service</div><div class="line">After=network.target</div><div class="line"></div><div class="line">[Service]</div><div class="line">Type=simple</div><div class="line">User=nobody</div><div class="line">Restart=on-failure</div><div class="line">RestartSec=5s</div><div class="line">ExecStart=/usr/local/bin/frpc -c /etc/frp/frpc.toml</div><div class="line">ExecReload=/usr/local/bin/frpc reload -c /etc/frp/frpc.toml</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div></pre></td></tr></table></figure>
<p>然后，刷新服务列表，设置开机自启、启动frps.service：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo systemctl daemon-reload</div><div class="line">sudo systemctl enable frpc.service</div><div class="line">sudo systemctl start frpc.service</div></pre></td></tr></table></figure>
<p>本服务器重启后，在终端确认frps.service的状态是成功启动：<br>
<code>sudo systemctl status frpc.service</code></p>
<p>至此，内网穿透目标实现：ssh、sftp、xrdp均可通过阿里云服务器进行反向代理，连接本服务器。</p>
<h3><span id="3-5-3-ke-xuan-kai-qi-frp-de-xtcp-fu-wu-shi-xian-duan-dui-duan-gao-su-nei-wang-chuan-tou">3.5.3 （可选）开启frp的xtcp服务，实现端对端高速内网穿透</span></h3>
<p>到目前为止，本服务器已经可以很稳定地从任何地点访问了：如果个人电脑在内网，使用服务器内网ip的22端口连接ssh，3389端口连接xrdp; 如果个人电脑在外网，则使用阿里云服务器ip的5022端口连接ssh，5023端口连接xrdp。</p>
<p>第二种方式是通用的，即使个人电脑在内网，也可以使用。同时，在手机、ipad等移动端上也很容易实施。</p>
<p>但有一个问题：阿里云服务器的带宽为3Mb，这意味着任何电脑从阿里云服务器下载数据的最高速度只有3Mb/8，为0.38MB每秒，或者约为400KB每秒。尽管上传数据至阿里云服务器的带宽更高（可能有100Mb），但通过tcp协议搭建的内网穿透连接，在任何情况下都需要同时受制于阿里云服务器的上传和下载两方面的带宽。</p>
<p>也就是说，根据木桶原理，在笔记本电脑和本服务器各自网络环境良好的情况下，前文中基于tcp协议搭建的穿透服务，最高的数据传输速度，只有400KB每秒。</p>
<p>这个速度，对于一般的ssh登陆、xrdp远程操作、jupyter notebook与vscode远程连接、一般的数据传输来说，基本够用了。</p>
<p>但有时也会出现上传或者下载大量数据的需求。这个时候，400KB每秒的速度就显得有些吃力了。解决的办法是在frp里面添加基于xtcp协议的点对点服务（即为隧道，或俗称“打洞”）。</p>
<p><img src="/page/server_related/files/explain_xtcp.png" alt="image"></p>
<p>打洞的原理如上图所示。原先基于tcp协议的frp穿透，工作原理如红色箭头所示，所有的传输都需要通过阿里云服务器中转。而基于xtcp协议的frp点对点穿透，工作原理如图中绿色箭头所示：阿里云服务器只负责让本服务器和笔记本电脑连接上，后面的数据传输不需要通过阿里云。</p>
<p>这样一来，每一个数据传输任务的带宽，就仅仅由笔记本电脑和本服务器所处的环境决定了，不再会受到阿里云3Mb带宽的限制。</p>
<p>需要做的事情：1. 阿里云服务器中的设置，不用更改。 2. 本服务器，需要在frpc.toml中添加基于xtcp协议的新服务。3. 笔记本电脑，需要安装frpc，并在frpc.toml中添加访问本服务器新添服务的信息。</p>
<p><strong>第一步</strong> 在上文设置好的本服务器<code>/etc/frp/frpc.toml</code>文件末尾添加下面信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">## 增加点对点穿透模式，供个人电脑与本服务器间传输文件时使用</div><div class="line"># [ ] 中的服务名与密码 yyyy，在个人电脑上的frpc配置中要用到</div><div class="line">[melonlon_ssh_p2p]</div><div class="line">type = xtcp</div><div class="line">sk = 123456</div><div class="line">local_ip = 127.0.0.1</div><div class="line">local_port = 22</div><div class="line"></div><div class="line"># 再为xrdp增加一个xtcp服务，也给未来其他连接预留备用</div><div class="line"># [ ] 中的服务名与密码 zzzz，在个人电脑上的frpc配置中要用到</div><div class="line">[melonlon_xrdp_p2p]</div><div class="line">type = xtcp</div><div class="line">sk = 123456</div><div class="line">local_ip = 127.0.0.1</div><div class="line">local_port = 3389</div></pre></td></tr></table></figure>
<p><strong>第二步</strong> 笔记本电脑(mac, linux, windows均可，去frp官网下载对应版本就行)的frpc.toml文件设置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">## 这部分的配置，根据阿里云服务器上/etc/frp/frps.toml 中内容设定</div><div class="line">[common]</div><div class="line">server_addr = x.x.x.x</div><div class="line">server_port = 5000</div><div class="line">token = xxxx</div><div class="line"></div><div class="line">## 这部分的配置，根据本服务器上/etc/frp/frpc.toml 中内容设定</div><div class="line">#将 computer1 换成特定电脑名称</div><div class="line">[computer1_ssh_p2p_vistor]</div><div class="line">type = xtcp</div><div class="line"># 角色为xtcp服务的访问者</div><div class="line">role = visitor</div><div class="line"># 下面两行信息，根据本服务器上/etc/frp/frpc.toml中对应服务信息写入</div><div class="line">server_name = melonlon_ssh_p2p</div><div class="line">sk = yyyy</div><div class="line"># 将远程端口映射为本地对应的端口</div><div class="line">bind_addr = 127.0.0.1</div><div class="line">bind_port = 9997</div><div class="line"># 当需要自动保持隧道打开时，设置为 true</div><div class="line">keep_tunnel_open = true</div><div class="line"># 每小时尝试打开隧道的次数</div><div class="line">max_retries_an_hour = 8</div><div class="line"># 重试打开隧道的最小间隔时间，单位: 秒</div><div class="line">min_retry_interval = 90	</div><div class="line"></div><div class="line"></div><div class="line">## 继续增加一个xtcp隧道，给xrdp或其他应用备用</div><div class="line">#将 computer1 换成特定电脑名称</div><div class="line">[computer1_xrdp_p2p_vistor]</div><div class="line">type = xtcp</div><div class="line"># 角色为xtcp服务的访问者</div><div class="line">role = visitor</div><div class="line"># 下面两行信息，根据本服务器上/etc/frp/frpc.toml中对应服务信息写入</div><div class="line">server_name = melonlon_xrdp_p2p</div><div class="line">sk = zzzz</div><div class="line"># 将远程端口映射为本地对应的端口</div><div class="line">bind_addr = 127.0.0.1</div><div class="line">bind_port = 9998</div><div class="line"># 当需要自动保持隧道打开时，设置为 true</div><div class="line">keep_tunnel_open = true</div><div class="line"># 每小时尝试打开隧道的次数</div><div class="line">max_retries_an_hour = 8</div><div class="line"># 重试打开隧道的最小间隔时间，单位: 秒</div><div class="line">min_retry_interval = 90</div></pre></td></tr></table></figure>
<p><strong>第三步</strong> 在笔记本电脑上启动frpc，成功后就可以通过<code>127.0.0.1:9997</code>端口ssh连接本服务器，或者通过<code>127.0.0.1:9998</code>端口xrdp连接本服务器。</p>
<p>提示：对于笔记本电脑，在mac下可以将<code>frpc -c /etc/frp/frpc.toml</code>之类的命令写入<code>.csh</code>文件(linux同此理)；在windows下可以将<code>D:\Programs\frp/frpc.exe -c D:\Programs\frp/frpc.toml</code>之类的命令写入<code>.bat</code> 文件。这样需要启动frp打洞连接时，只需要点击文件执行即可，不用每次都去终端输入命令。</p>
<p>因为用的少，对于笔记本电脑上的frpc，不建议建立开机启动的服务。</p>
<p>总结一下两种frp反向代理方式的区别。以从笔记本电脑连ssh接本服务器为例：</p>
<ul>
<li>基于tcp的穿透，是通过连接 <code>[阿里云ip]:5022</code>继而连接本服务器的<code>127.0.0.1:22</code>，且连接中所有传输都要通过<code>[阿里云ip]:5022</code>中转。</li>
<li>基于xtcp的穿透，是通过连接笔记本电脑的<code>127.0.0.1:9997</code>继而直接连上（尽管确认建立连接时需要云服务器确认一下）了本服务器的<code>127.0.0.1:22</code>，且后续的数据传输都是两个设备之间直接进行，不需要云服务器中转。</li>
</ul>
<p>另外，有趣的一点是，当一台电脑成功开启了隧道，就可以自动为所在局域网下其他设备打洞：如果家里有一台笔记本电脑成功开启了隧道，那么路由器下的所有其他设备（即使没有安装frpc的），都可以通过<code>[笔记本电脑局域网ip]:9997</code>和<code>[笔记本电脑局域网ip]:9998</code>端口分别对本服务器进行ssh和xrdp访问。</p>
<p>下图为当笔记本电脑和本服务器处于同一路由器下的测试结果：<br>
<img src="/page/server_related/files/speed_compare.PNG" alt="image"><br>
可以看到，基于tcp协议的普通穿透下，传输速度受到了阿里云带宽制约。而xtcp协议下的点对点穿透下，传输速度和本地直连方式相同，几乎达到了前兆路由器的极限值。</p>
<p>下图为当笔记本电脑处于电信宽带下、本服务器处于移动宽带下的测试结果：<br>
<img src="/page/server_related/files/speed_compare1.png" alt="image"><br>
可以看到，想较普通穿透下的400KB下载速度，点对点穿透下的下载速度达到了3.8MB每秒，已经达到了普通宽带网络的上行带宽（一般家庭宽带的上行速度，只有30Mb，想要解锁上行带宽，往往需要额外付费）。</p>
<p>由此可以推断，如果笔记本电脑在家里（下行带宽1000Mb，上行带宽30Mb），本服务器在教育网（下行、上行带宽均为100Mb），那么通过xtcp隧道上传数据至本服务器的速度约为3.5MB/秒，而从服务器下载数据的速度约为12MB/秒。</p>
<p>至此，frp穿透设置全部完成：总结一下，以ssh和xrdp为例，有两种穿透方式：</p>
<ul>
<li>在任何终端设备上，基于tcp的穿透，通过 <code>[阿里云ip]:5022</code>端口连接ssh，通过<code>[阿里云ip]:5023</code>端口连接xrdp。</li>
<li>在安装了frpc的终端设备上，在成功运行frpc，开启隧道前提下，基于xtcp的穿透，通过 <code>127.0.0.1:9997</code>端口连接ssh，通过<code>127.0.0.1:9998</code>端口连接xrdp。</li>
</ul>
<br>
<h1><span id="4-chang-yong-ji-suan-ruan-jian-an-zhuang">4. 常用计算软件安装</span></h1>
<br>
<h1><span id="5-fu-wu-qi-wei-hu-za-xiang">5. 服务器维护杂项</span></h1>
<h2><span id="5-1-xiu-gai-ssh-deng-lu-huan-ying-jie-mian">5.1 修改ssh登陆欢迎界面</span></h2>
<p>使用命令<code>ls /etc/update-motd.d/</code>查看ssh登陆的欢迎界面各个部分的定义文件：</p>
<p><img src="/page/server_related/files/ssh_welcome.png" alt="image"></p>
<p>例如要修改欢迎界面中的帮助说明，可以使用<code>sudo</code>权限修改下面文件：<br>
<code>sudo nano /etc/update-motd.d/10-help-text</code></p>
<p>再比如，如果要添加欢迎界面的字符画，可以考虑在<code>/etc/</code>路径下新建文件：<br>
<code>sudo nano /etc/hello.file</code><br>
将网上生成的ASCII字符画直接复制粘贴进去上面的文件。</p>
<p>再把该文件读入header中：<br>
先打开<code>sudo nano /etc/update-motd.d/00-header</code>  ，再在文件末尾加上一行：<br>
<code>cat /etc/hello.file</code><br>
保存退出后，重新登陆ssh即可看到位于header末尾的字符画。</p>
<h2><span id="5-2-guan-li-user-he-group">5.2 管理user和group</span></h2>
<ul>
<li>添加用户：<br>
<code>sudo adduser test_user #添加用户</code><br>
<code>sudo addgroup test_group #添加用户组</code><br>
<code>sudo useradd -m username -s /bin/bash -g test_group #添加用户时制定群组、主目录名、和新账户的登陆shell</code><br>
<code>sudo passwd username #修改密码</code></li>
<li>用户组：<br>
<code>sudo adduser test_user test_group</code><br>
<code>sudo usermod -g test_group test_user #修改用户的组</code><br>
<code>cat /etc/group | grep 'test_group' #查看用户组下成员</code><br>
<code>groupmod -n newname oldname #修改用户组名称</code></li>
<li>将普通用户赋予管理员权限（上文中有另一种方法）：<br>
先：<code>sudo chmod +w /etc/sudoers</code><br>
再：<code>sudo nvim /etc/sudoers</code></li>
<li>删除用户：<br>
<code>sudo userdel -r test_user</code></li>
</ul>
<h2><span id="5-3-xiu-gai-yong-hu-mi-ma-ce-lue">5.3 修改用户密码策略</span></h2>
<ul>
<li>设置最短密码长度：<br>
在<code>sudo vim /etc/pam.d/common-password</code>中寻找<code>minlen</code>赋值。</li>
<li>设置密码复杂度：<br>
在<code>sudo vim /etc/pam.d/common-password</code>中寻找ucredit, lcredit, dcredit, ocredit的赋值，分别表示最少需要有多少个大写字母、小写字母、数字、标点符号。</li>
<li>设置密码过期时间：<br>
在<code>sudo vim /etc/login.defs</code>中寻找<code>PASS_MAX_DAYS</code>部分各变量赋值。</li>
<li>强制用户首次登陆时修改密码：<br>
设置新用户名和初始密码后，用下面命令修改该用户密码是在1970年1月1日更改的，这会使得当前密码立即到期，从而需要在下一次登陆时更改：<br>
<code>chage -d 0 test_user</code></li>
<li>查看test_user的密码情况：<br>
<code>chage -l test_user</code></li>
</ul>
<h2><span id="5-4-gua-zai-ci-pan-ji-she-zhi-yong-hu-qun-zu-quan-xian">5.4 挂载磁盘及设置用户群组权限</span></h2>
<h3><span id="5-4-1-ge-shi-hua-yu-gua-zai-ci-pan">5.4.1 格式化与挂载磁盘</span></h3>
<p>以本机器的RAID1磁盘为例，我们将此磁盘格式化（Ext4格式），命名为data_raid，并挂载（mount）到admin用户下某路径，使admin成为该路径的owner，这些设置以后还能更改。</p>
<p>上述目标，都可以很容易的在ubuntu图形界面实现：使用admin账号登陆后，进入Disks管理工具，选择对应磁盘，就可进行Parttitioning，Take Ownership，Mount(和Unmount)等操作。</p>
<p>同样地，这些目标也可以通过终端命令实现（已通过<code>sudo fdisk -l</code>命令看到磁盘的设备名称为/dev/sda）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">sudo fdisk /dev/sda     #如果磁盘没有分区，才先执行此操作，否则直接进入后面格式化步骤</div><div class="line"></div><div class="line">sudo mkfs -t ext4 -c /dev/sda     #格式化，等待时间较长，可考虑 nohup *** &amp; 后台运行方式</div><div class="line">sudo mkdir /data_raid                 #创建挂载点</div><div class="line">sudo mount /dev/sda /data_raid  #挂载</div></pre></td></tr></table></figure>
<p>终端输入<code>df -lh</code>，可以看到磁盘已经挂载好了。<br>
<img src="/page/server_related/files/mounted_disk.png" alt="image"></p>
<h3><span id="5-4-2-she-zhi-yong-hu-qun-zu-quan-xian">5.4.2 设置用户群组权限</span></h3>
<p>本机器已有足够系统盘空间供用户日常使用(<code>\home</code>分区为1.48T)，因此挂载的data_raid磁盘只供部分用户存储重要数据，需要设置好用户群组权限。</p>
<p>首先查看该磁盘的权限：<code>ls -ld /data_raid</code><br>
<img src="/page/server_related/files/permission_status1.png" alt="image"></p>
<p>可以看到，该磁盘目前的owner是admin，group也是admin（每个用户默认是自己的群组成员），且权限状态为<code>drwx------</code>。其中<code>d</code>代表文件夹(<code>-</code>代表文件，<code>l</code>代表链接)，不需要我们设置。<br>
我们能更改的设置，是后面的9个字母，三个一组，共三组。这三组字母，分别对应owner，group，和other的权限。在这里，<code>d</code>后面接着的<code>rwx</code>表示owner有该文件夹的<code>r</code>（读）、<code>w</code>（写）、<code>x</code>（执行）的权限。而后面6个数位用短横线代替字母，表示目前group和other没有任何rwx权限。</p>
<p>我的权限设置目标是：让admin用户只有<code>r</code>权限，让data_raid_group群组中的用户有<code>rwx</code>权限，而other没有任何权限。也就是说我想要将<code>drwx------</code>改为<code>dr--rwx---</code>。</p>
<p>使用chmod命令更改时，我们赋予<code>r</code>权限4分、<code>w</code>权限2分、<code>x</code>权限1分。这样我们只需要注明对onwer、group、other的权限总分即可。在本例中，onwer权限4分、group权限7分、other权限0分。即需要设置chmod 参数 <code>470</code>。</p>
<p>使用下面命令修改权限：<br>
<code>sudo chmod -R 470 /data_raid</code><br>
其中参数<code>-R</code>表示递归变更目录及子目录和文件的权限。</p>
<p>再查看该磁盘目前的权限状态，确认修改成功：<br>
<img src="/page/server_related/files/permission_status2.png" alt="image"></p>
<p>接下来，我们只需要将平时会使用磁盘的其他用户加入data_raid_group群组，并重新定义该磁盘对应的用户和群组即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo addgroup data_raid_group</div><div class="line">sudo adduser ming data_raid_group</div><div class="line">sudo chown -R admin:data_raid_group /data_raid/</div></pre></td></tr></table></figure>
<p>验证路径权限更改成功：<br>
<img src="/page/server_related/files/permission_check.png" alt="image"></p>
<p><strong>注意</strong>：<code>mount</code>命令在系统重启后会失效！也就是说，系统默认用户会在需要使用磁盘时候，将其挂载，不用的时候就不挂载，甚至会在使用结束后主动使用<code>umount</code>命令将其卸载。这点和windows很不一样，需要适应linux的挂载逻辑。</p>
<p>但如果希望该磁盘在系统启动时变自动挂载至指定点，也可以通过下面的设置达到目的。<br>
首先通过下面命令找到该磁盘的格式以及 UUID=“123-456-789”：<br>
<code>sudo blkid /dev/sda</code></p>
<p>然后打开文件 <code>sudo nano /etc/fstab</code>   在文档末尾添加一行磁盘挂载信息后保存退出：<br>
<code>UUID=123-456-789 /data_raid ext4 defaults 0 2</code><br>
说明：defaults 表示使用默认挂载选项，0 表示不在备份时检查，2 表示在启动时进行自动检查。</p>
<p>使用以下命令重新挂载 /etc/fstab 中的项：<br>
<code>sudo mount -a</code></p>
<p>使用 df -h 命令验证磁盘是否已成功挂载。<br>
<code>df -lh</code></p>
<p>以后该磁盘就会在系统启动时自动挂载至/data_raid。</p>
<h2><span id="5-5-xiu-gai-ji-qi-ming-cheng">5.5 修改机器名称</span></h2>
<p>将下面两个文件中的机器名称做相应修改后，重启即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo nano /etc/hostname       </div><div class="line">sudo nano /etc/hosts</div></pre></td></tr></table></figure>
<h2><span id="5-6">5.6</span></h2>

    
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/user2.png"
               alt="Ming Yi （yiming.econ@gmail.com）" />
          <p class="site-author-name" itemprop="name">Ming Yi （yiming.econ@gmail.com）</p>
           
              <p class="site-description motion-element" itemprop="description">Associate Professor of Economics, Huazhong University of Science and Technology, Wuhan China</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">20</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-block">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-link"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="https://johnhcochrane.blogspot.com" title="the Grumpy Economist (John Cochrane)'s Blog" target="_blank">the Grumpy Economist (John Cochrane)'s Blog</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://www.cato.org" title="Cato Institute" target="_blank">Cato Institute</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://macrofinancesociety.org" title="Macro Finance Society" target="_blank">Macro Finance Society</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-text">1. 机器配置</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-text">2. 安装操作系统</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-text">3. Ubuntu系统设置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-text">3.1 给root用户添加密码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-text">3.2 更换ubuntu下载源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-text">3.3 安装Nvidia显卡驱动</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#undefined"><span class="nav-text">3.3.1 安装Nvidia驱动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#undefined"><span class="nav-text">3.3.2 禁用nouveau驱动</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-text">3.4 开启网络服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#undefined"><span class="nav-text">3.4.1 开启ssh服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#undefined"><span class="nav-text">3.4.2 给root账户ssh登陆权限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#undefined"><span class="nav-text">3.4.3 关于远程桌面（安装xrdp）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-text">3.5 公网ip与内网穿透</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#undefined"><span class="nav-text">3.5.1 在云服务器上安装frps (server)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#undefined"><span class="nav-text">3.5.2 在本机器上安装frpc (client)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#undefined"><span class="nav-text">3.5.3 （可选）开启frp的xtcp服务，实现端对端高速内网穿透</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-text">4. 常用计算软件安装</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-text">5. 服务器维护杂项</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-text">5.1 修改ssh登陆欢迎界面</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-text">5.2 管理user和group</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-text">5.3 修改用户密码策略</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-text">5.4 挂载磁盘及设置用户群组权限</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#undefined"><span class="nav-text">5.4.1 格式化与挂载磁盘</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#undefined"><span class="nav-text">5.4.2 设置用户群组权限</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-text">5.5 修改机器名称</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-text">5.6</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-anchor"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ming Yi （yiming.econ@gmail.com）</span>
</div>



        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  




<script type="text/x-mathjax-config">
MathJax.Hub.Config({
TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>

  

  

</body>
</html>
